#!/usr/bin/env ruby
# -*- mode: ruby;-*-

require 'optparse'
require './lib/compiler'
require './lib/vm'

def main()
  opt = OptionParser.new
  opt.on('--dump-ir')
  params = {}
  opt.parse!(ARGV, into: params)

  global = {}
  compiler = Compiler.new(global, [])
  compiler.compile(ARGF)

  if params[:"dump-ir"]
    global.each do |k, v|
      puts "=== #{k} #{v[0].inspect}"
      v[1].dump()
      puts ""
    end
    compiler.bbcon.dump()
    return
  end

  vm = VM.new(global, compiler.bbcon.bbs)
  result = vm.run()
  p result
end

if $0 == __FILE__
  main()
end
